name: CI - golang
on:
  workflow_call:
    inputs:
      # used in Voedger to skip copyright check in cmd/voedger/sys.monitor/site.main
      ignore_copyright: # deprecated
        required: false
        type: string
      # used in Voedger to run tests in pkg/ only
      test_folder:
        required: false
        type: string
      ignore_bp3: # deprecated
        required: false
        type: string
      short_test:
        required: false
        type: string
      go_race:
        required: false
        type: string
      ignore_build: # deprecated
        required: false
        type: string
      test_subfolders:
        required: false
        type: string
      running_workflow:
        required: false
        type: string
      build_cmd:
        required: false
        type: string
      fiscal_vatnr:
        required: false
        type: string
      fiscal_caption:
        required: false
        type: string
      mode:
        required: false
        type: string
      extra_env:
        required: false
        type: string
      install_tinygo:
        required: false
        type: string
    secrets:
      reporeading_token:
        required: true
      codecov_token: # deprecated
        required: false
      personal_token:
        required: false
      chargebee_token: # deprecated
        required: false
      chargebee_sitename: # deprecated
        required: false

jobs:
  validate-code:
    name: Validate code
    runs-on: ubuntu-22.04
    outputs:
      language: ${{ steps.detect-language.outputs.language }}
    steps:
      - name: Codecov
        if: inputs.mode == 'norebuild'
        run: |
          curl -Os https://uploader.codecov.io/latest/linux/codecov
          chmod +x codecov
          ./codecov

      - name: Detect language
        id: detect-language
        shell: bash
        env:
          github_token: ${{ secrets.reporeading_token }}
        run: |
          set -Eeuo pipefail
          LANGUAGE=$(curl -s https://raw.githubusercontent.com/untillpro/ci-action/main/scripts/detect_language.sh | bash)
          echo "Detected language: $LANGUAGE"
          if [ "$LANGUAGE" = "unknown" ]; then
            echo "Error: project language unknown" >&2
            exit 1
          fi
          echo "LANGUAGE=$LANGUAGE" >> "$GITHUB_ENV"
          echo "language=$LANGUAGE" >> "$GITHUB_OUTPUT"

      - name: Checkout (if not yet)
        uses: actions/checkout@v5
        if: ${{ hashFiles('.git/HEAD') == '' }} # checkout only if not checked out yet
        with:
          token: ${{ inputs.token || github.token }}
          ref: ${{ inputs.ref || ((github.event_name == 'pull_request' || github.event_name == 'pull_request_target') && github.event.pull_request.head.sha || github.sha) }}
          submodules: ${{ inputs.submodules }}
          path: ${{ inputs.path }}
          fetch-depth: 0 # note: 0 need to make check_copyright.sh work properly (getting diff between PR and main)

      - name: Check hidden folders
        shell: bash
        run: curl -s https://raw.githubusercontent.com/untillpro/ci-action/main/scripts/reject_hidden_folders.sh | bash -s

      - name: Check copyright
        run: curl -s https://raw.githubusercontent.com/untillpro/ci-action/main/scripts/check_copyright.sh | bash -s

  run-tests-go:
    name: Run tests (Go)
    runs-on: ubuntu-22.04
    needs: validate-code
    if: ${{ needs.validate-code.outputs.language == 'go' }}
    steps:
      - name: Checkout (if not yet) and Set Up Go
        id: go-setup
        uses: untillpro/ci-action/checkout-and-setup-go@main

      - name: Install TinyGo
        if: inputs.install_tinygo == 'true'
        run: curl -s https://raw.githubusercontent.com/untillpro/ci-action/main/scripts/install-tinygo.sh | bash -s "${{ steps.go-setup.outputs.go-version }}"

      - name: Apply EXTRA_ENV
        if: inputs.extra_env != ''
        shell: bash
        run: |
          set -Eeuo pipefail
          EXTRA_ENV="${{ inputs.extra_env }}"
          while IFS= read -r line; do
            if [ -z "$line" ] || [[ "$line" =~ ^[[:space:]]*# ]]; then
              continue
            fi
            if [[ "$line" != *=* ]]; then
              echo "Error: invalid EXTRA_ENV entry (no '='): $line" >&2
              exit 1
            fi
            var_name="${line%%=*}"
            var_value="${line#*=}"
            if [ -z "$var_name" ]; then
              echo "Error: invalid EXTRA_ENV entry (empty name): $line" >&2
              exit 1
            fi
            if [ -z "$var_value" ]; then
              echo "Skipping EXTRA_ENV $var_name with empty value" >&2
              continue
            fi
            echo "$var_name=$var_value" >> "$GITHUB_ENV"
            echo "Exported EXTRA_ENV $var_name=$var_value" >&2
          done <<< "$EXTRA_ENV"

      - name: Check go.mod
        shell: bash
        run: curl -s https://raw.githubusercontent.com/untillpro/ci-action/main/scripts/check_gomod.sh | bash -s

      - name: Run tests
        shell: bash
        env:
          ORGANIZATION: "untillpro"
          TOKEN: ${{ secrets.reporeading_token }}
          CODECOV_TOKEN: ${{ secrets.codecov_token }}
          CODECOV_GO_RACE: ${{ inputs.go_race }}
          REPOSITORY: ${{ github.repository }}
          RUN_MOD_TIDY: "false"
          MAIN_BRANCH: "main"
          TEST_FOLDER: ${{ inputs.test_folder }}
          SHORT_TEST: ${{ inputs.short_test }}
          BUILD_CMD: ""
        run: curl -s https://raw.githubusercontent.com/untillpro/ci-action/main/scripts/ci_go.sh | bash -s

      - name: Test subfolders
        if: inputs.test_subfolders == 'true'
        run: |
          if [ "${{ inputs.short_test }}" == "true" || "${{ inputs.mode }}" = "pr" ]; then
            curl -s https://raw.githubusercontent.com/untillpro/ci-action/main/scripts/test_subfolders.sh | bash -s short
          else
            curl -s https://raw.githubusercontent.com/untillpro/ci-action/main/scripts/test_subfolders.sh | bash -s full
          fi

      - name: Linters
        run: curl -s https://raw.githubusercontent.com/untillpro/ci-action/main/scripts/run-linters.sh | bash -s
        env:
          testfolder: ${{ inputs.test_folder }}

      - name: Vulnerability check
        shell: bash
        if: inputs.short_test != 'true'
        run: curl -s https://raw.githubusercontent.com/untillpro/ci-action/main/scripts/vulncheck.sh | bash -s

  run-tests-nodejs:
    name: Run tests (Node.js)
    runs-on: ubuntu-22.04
    needs: validate-code
    if: ${{ needs.validate-code.outputs.language == 'node_js' }}
    steps:
      - name: Run tests (Node.js)
        shell: bash
        env:
          CODECOV_TOKEN: ${{ secrets.codecov_token }}
        run: curl -s https://raw.githubusercontent.com/untillpro/ci-action/main/scripts/ci_node_js.sh | bash -s

  build-and-upload:
    name: Build and upload Go project (deprecated)
    runs-on: ubuntu-22.04
    needs: run-tests-go
    steps:

      - name: Chechout
        uses: actions/checkout@v5

      - name: Build executable
        run: |
          git config --global url."https://${{ secrets.REPOREADING_TOKEN }}:x-oauth-basic@github.com/untillpro".insteadOf "https://github.com/untillpro"
          ${{ inputs.build_cmd }}
        env:
          GOPRIVATE: "github.com/untillpro/*"

      - name: Upload project
        uses: actions/upload-artifact@v4
        with:
          name: project-files
          path: .
          retention-days: 1
