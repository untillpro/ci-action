name: CI - golang
on:
  workflow_call:
    inputs:
      ignore_copyright:
        required: false
        type: string
      test_folder:
        required: false
        type: string
      ignore_bp3:
        required: false
        type: string
      short_test:
        required: false
        type: string
      commit_name:
        required: false
        type: string
      go_race:
        required: false
        type: string
      ignore_build:
        required: false
        type: string
      test_subfolders:
        required: false
        type: string
      running_workflow:
        required: false
        type: string
      build_cmd:
        required: false
        type: string
      fiscal_vatnr:
        required: false
        type: string
      fiscal_caption:
        required: false
        type: string
      mode:
        required: false
        type: string
    secrets:
      reporeading_token:
        required: true
      codecov_token:
        required: false
      personal_token:
        required: false
      chargebee_token:
        required: false
      chargebee_sitename:
        required: false

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Log GitHub event name
        run: echo "github.event_name=${{ github.event_name }}"

      - name: Checkout (PR)
        if: inputs.mode == 'pr'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Checkout
        if: inputs.mode != 'pr'
        uses: actions/checkout@v4

      - name: Detect Go version
        id: detect-go
        run: |
          curl -s https://raw.githubusercontent.com/untillpro/ci-action/main/scripts/detect-go-version.sh | bash -s

      - name: Cache Go - Modules
        if: inputs.mode != 'cas'
        uses: actions/cache@v4
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ steps.detect-go.outputs.go-version }}
          cache: false

      - name: Install TinyGo
        if: inputs.mode != 'norebuild'
        run: |
          curl -s https://raw.githubusercontent.com/untillpro/ci-action/main/scripts/install-tinygo.sh | bash -s "${{ steps.detect-go.outputs.go-version }}"

      - name: Check pull request file size
        if: github.event_name == 'pull_request'
        run: curl -s https://raw.githubusercontent.com/untillpro/ci-action/main/scripts/checkPR.sh | bash
        env:
          token: ${{ secrets.reporeading_token }}
          pr_number: ${{ github.event.number }}

      - name: Check if another workflow running and cancel it
        if: github.event_name == 'pull_request' && inputs.mode == 'pr' && inputs.running_workflow != ''
        run: curl -s https://raw.githubusercontent.com/untillpro/ci-action/main/scripts/cancelworkflow.sh | bash
        env:
          GH_TOKEN: ${{ secrets.personal_token }}
          repo: ${{ github.repository }}
          branch: ${{ github.event.pull_request.head.ref }}
          runningworkflow: ${{ inputs.running_workflow }}

      - name: Codecov
        if: inputs.mode == 'norebuild'
        run: |
          curl -Os https://uploader.codecov.io/latest/linux/codecov
          chmod +x codecov
          ./codecov

      - name: CI
        uses: untillpro/ci-action@main
        with:
          ignore: ${{ inputs.ignore_copyright }}
          test-folder: ${{ inputs.test_folder }}
          organization: "untillpro,heeus"
          token: ${{ secrets.reporeading_token }}
          codecov-token: ${{ secrets.codecov_token }}
          short-test: ${{ inputs.short_test }}
          ignore-build: ${{ inputs.ignore_build }}
          codecov-go-race: ${{ inputs.go_race }}
          run-mod-tidy: false
        env:
          CHARGEBEE_PUBLISHABLE_KEY: ${{ secrets.chargebee_token }}
          CHARGEBEE_SITE_NAME: ${{ secrets.chargebee_sitename }}
          FISCALCLOUD_TEST_GERMANY_VATNR: ${{ inputs.fiscal_vatnr }}
          FISCALCLOUD_TEST_GERMANY_CAPTION: ${{ inputs.fiscal_caption }}

      - name: Test subfolders
        if: inputs.test_subfolders == 'true' && inputs.mode != 'pr'
        run: |
          if [ "${{ inputs.short_test }}" == "true" ]; then
            curl -s https://raw.githubusercontent.com/untillpro/ci-action/main/scripts/test_subfolders.sh | bash -s short
          else
            curl -s https://raw.githubusercontent.com/untillpro/ci-action/main/scripts/test_subfolders.sh | bash -s full
          fi

      - name: Test subfolders (PR)
        if: inputs.test_subfolders == 'true' && inputs.mode == 'pr'
        run: |
          curl -s https://raw.githubusercontent.com/untillpro/ci-action/main/scripts/test_subfolders.sh | bash -s

      - name: Build executable
        if: inputs.mode == 'cas'
        run: |
          git config --global url."https://${{ secrets.REPOREADING_TOKEN }}:x-oauth-basic@github.com/heeus".insteadOf "https://github.com/heeus"
          git config --global url."https://${{ secrets.REPOREADING_TOKEN }}:x-oauth-basic@github.com/untillpro".insteadOf "https://github.com/untillpro"
          ${{ inputs.build_cmd }}
        env:
          GOPRIVATE: "github.com/untillpro/*,github.com/heeus/*"

      - name: Upload project
        if: inputs.mode == 'cas'
        uses: actions/upload-artifact@v4
        with:
          name: project-files
          path: .
          retention-days: 1

      - name: Copyright
        if: inputs.mode != 'cas' || inputs.build_cmd != ''
        run: curl -s https://raw.githubusercontent.com/untillpro/ci-action/main/scripts/check_copyright.sh | bash -s

      - name: Linters
        if: inputs.mode != 'cas' && inputs.mode != 'norebuild'
        run: curl -s https://raw.githubusercontent.com/untillpro/ci-action/main/scripts/run-linters.sh | bash -s
        env:
          testfolder: ${{ inputs.test_folder }}

      - name: Linters (norebuild)
        if: inputs.mode == 'norebuild'
        run: curl -s https://raw.githubusercontent.com/untillpro/ci-action/main/scripts/run-linters.sh | bash -s
